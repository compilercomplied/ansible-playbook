---
- name: Bootstrap - Generate Inventory and Hosts
  hosts: localhost
  connection: local
  become: true
  tags: always
  vars:
    secrets_repo: "git@github.com:compilercomplied/hosts-secrets.git"
    temp_secrets_path: "/tmp/hosts-secrets-bootstrap"

  tasks:
    - name: Clone Secrets Repo to temp location
      become: no
      ansible.builtin.git:
        repo: "{{ secrets_repo }}"
        dest: "{{ temp_secrets_path }}"
        version: master
        accept_hostkey: yes
        force: yes

    - name: Parse hosts map CSV with Python script
      ansible.builtin.command:
        cmd: "{{ playbook_dir }}/scripts/parse_inventory.py {{ temp_secrets_path }}/hosts/map.csv"
      register: csv_parse_result
      changed_when: false

    - name: Set parsed hosts fact
      set_fact:
        parsed_hosts: "{{ csv_parse_result.stdout | from_json }}"

    - name: Debug parsed hosts
      debug:
        var: parsed_hosts

    - name: Add servers to in-memory inventory
      ansible.builtin.add_host:
        name: "{{ item.fqdn }}"
        groups: servers
        ansible_python_interpreter: /usr/bin/python3
        ansible_host: "{{ item.ip }}"
      loop: "{{ parsed_hosts }}"

    - name: Add workstations group (ensure localhost is in it)
      ansible.builtin.add_host:
        name: localhost
        groups: workstations
        ansible_connection: local
        ansible_python_interpreter: /usr/bin/python3
      changed_when: false

    - name: Add all hosts to /etc/hosts
      ansible.builtin.lineinfile:
        path: /etc/hosts
        line: "{{ item.ip }} {{ item.fqdn }}"
        regexp: "^{{ item.ip }}\\s+{{ item.fqdn | regex_escape }}"
        state: present
      loop: "{{ parsed_hosts }}"

    - name: Remove temporary secrets repo
      ansible.builtin.file:
        path: "{{ temp_secrets_path }}"
        state: absent
