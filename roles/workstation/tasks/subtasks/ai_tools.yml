---
- name: Check if Claude Code is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/.local/bin/claude"
  register: claude_check

- name: Install Global AI Tools (Claude Code)
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      export PATH="$HOME/.local/bin:$PATH"
      curl -fsSL https://claude.ai/install.sh | bash
    executable: /bin/bash
  when: not claude_check.stat.exists

- name: Check if Gemini CLI is installed
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    npm list -g @google/gemini-cli
  register: gemini_check
  failed_when: false
  changed_when: false

- name: Install Gemini CLI
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      export PATH="/home/{{ target_user }}/.fnm:$PATH"
      eval "`fnm env`"
      npm install -g @google/gemini-cli
    executable: /bin/bash
  when: gemini_check.rc != 0

- name: Check if Github Copilot is installed
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    npm list -g @github/copilot
  register: copilot_check
  failed_when: false
  changed_when: false

- name: Install GitHub Copilot CLI
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      export PATH="/home/{{ target_user }}/.fnm:$PATH"
      eval "`fnm env`"
      npm install -g @github/copilot
    executable: /bin/bash
  when: copilot_check.rc != 0
