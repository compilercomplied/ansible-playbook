---
# --- GOLANG SETUP ---
- name: Determine Go Architecture
  ansible.builtin.set_fact:
    go_arch: "{{ 'amd64' if ansible_architecture == 'x86_64' else 'arm64' if ansible_architecture == 'aarch64' else 'amd64' }}"

- name: Check installed Go version
  ansible.builtin.shell: /usr/local/go/bin/go version | grep -q "go{{ programming_languages.go }}"
  register: go_version_check
  failed_when: false
  changed_when: false

- name: Download Go tarball
  ansible.builtin.get_url:
    url: "https://go.dev/dl/go{{ programming_languages.go }}.linux-{{ go_arch }}.tar.gz"
    dest: "/tmp/go.tar.gz"
  when: go_version_check.rc != 0

- name: Remove old Go installation
  ansible.builtin.file:
    path: /usr/local/go
    state: absent
  when: go_version_check.rc != 0

- name: Extract Go
  ansible.builtin.unarchive:
    src: "/tmp/go.tar.gz"
    dest: /usr/local
    remote_src: yes
  when: go_version_check.rc != 0

- name: Add Go to system path (profile.d)
  ansible.builtin.copy:
    dest: /etc/profile.d/go.sh
    content: 'export PATH=$PATH:/usr/local/go/bin'
    mode: '0644'

- name: Add Go to user .bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.bashrc"
    regexp: 'export PATH=\$PATH:/usr/local/go/bin'
    line: 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin'
    create: yes
    owner: "{{ target_user }}"

- name: Add Go to user .profile
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.profile"
    regexp: 'export PATH=\$PATH:/usr/local/go/bin'
    line: 'export PATH=$PATH:/usr/local/go/bin:$HOME/go/bin'
    create: yes
    owner: "{{ target_user }}"

- name: Check if gopls is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/go/bin/gopls"
  register: gopls_check

- name: Install gopls
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.command: /usr/local/go/bin/go install golang.org/x/tools/gopls@latest
  when: not gopls_check.stat.exists

# --- RUST SETUP ---
- name: Check if Rust is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/.cargo/bin/rustup"
  register: rustup_check

- name: Download Rustup installer
  ansible.builtin.get_url:
    url: https://sh.rustup.rs
    dest: /tmp/sh.rustup.rs
    mode: '0755'
  when: not rustup_check.stat.exists

- name: Install Rust (User space)
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: /tmp/sh.rustup.rs -y
  when: not rustup_check.stat.exists

- name: Source Cargo in .bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.bashrc"
    line: '. "$HOME/.cargo/env"'
    create: yes
    owner: "{{ target_user }}"

- name: Source Cargo in .profile
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.profile"
    line: '. "$HOME/.cargo/env"'
    create: yes
    owner: "{{ target_user }}"

# --- NODEJS / FNM SETUP ---
- name: Check if fnm is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/.fnm/fnm"
  register: fnm_check

- name: Download fnm installer
  ansible.builtin.get_url:
    url: https://fnm.vercel.app/install
    dest: /tmp/install_fnm.sh
    mode: '0755'
  when: not fnm_check.stat.exists

- name: Install fnm
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: /tmp/install_fnm.sh --install-dir "/home/{{ target_user }}/.fnm" --skip-shell
  when: not fnm_check.stat.exists

- name: Configure fnm in .bashrc
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.bashrc"
    marker: "# {mark} ANSIBLE MANAGED BLOCK (FNM)"
    block: |
      export PATH="/home/{{ target_user }}/.fnm:$HOME/.local/bin:$PATH"
      eval "`fnm env`"
    owner: "{{ target_user }}"

- name: Configure fnm in .profile
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.profile"
    marker: "# {mark} ANSIBLE MANAGED BLOCK (FNM)"
    block: |
      export PATH="/home/{{ target_user }}/.fnm:$HOME/.local/bin:$PATH"
      eval "`fnm env`"
    owner: "{{ target_user }}"

- name: Check if Node is installed
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    node --version
  register: node_check
  failed_when: false
  changed_when: false

- name: Install Latest Node via fnm
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    fnm install --latest
    fnm default latest
  args:
    executable: /bin/bash
  when: node_check.rc != 0

- name: Check if Claude Code is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/.local/bin/claude"
  register: claude_check

- name: Install Global AI Tools (Claude Code)
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      set -o pipefail
      export PATH="$HOME/.local/bin:$PATH"
      curl -fsSL https://claude.ai/install.sh | bash
    executable: /bin/bash
  when: not claude_check.stat.exists

- name: Check if Gemini CLI is installed
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    npm list -g @google/gemini-cli
  register: gemini_check
  failed_when: false
  changed_when: false

- name: Install Gemini CLI
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      export PATH="/home/{{ target_user }}/.fnm:$PATH"
      eval "`fnm env`"
      npm install -g @google/gemini-cli
    executable: /bin/bash
  when: gemini_check.rc != 0

- name: Check if Github Copilot is installed
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    export PATH="/home/{{ target_user }}/.fnm:$PATH"
    eval "`fnm env`"
    npm list -g @github/copilot
  register: copilot_check
  failed_when: false
  changed_when: false

- name: Install GitHub Copilot CLI
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell:
    cmd: |
      export PATH="/home/{{ target_user }}/.fnm:$PATH"
      eval "`fnm env`"
      npm install -g @github/copilot
    executable: /bin/bash
  when: copilot_check.rc != 0

# --- PULUMI SETUP ---
- name: Check if Pulumi is installed
  ansible.builtin.stat:
    path: "/home/{{ target_user }}/.pulumi/bin/pulumi"
  register: pulumi_check
  become: yes
  become_user: "{{ target_user }}"

- name: Download Pulumi installer script
  ansible.builtin.get_url:
    url: https://get.pulumi.com/
    dest: /tmp/install_pulumi.sh
    mode: '0755'
  when: not pulumi_check.stat.exists

- name: Install Pulumi
  become: yes
  become_user: "{{ target_user }}"
  ansible.builtin.shell: |
    /tmp/install_pulumi.sh
  args:
    creates: "/home/{{ target_user }}/.pulumi/bin/pulumi"
  when: not pulumi_check.stat.exists

- name: Add Pulumi to user .bashrc
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.bashrc"
    regexp: 'export PATH=\$PATH:\$HOME/\.pulumi/bin'
    line: 'export PATH=$PATH:$HOME/.pulumi/bin'
    create: yes
    owner: "{{ target_user }}"

- name: Add Pulumi to user .profile
  ansible.builtin.lineinfile:
    path: "/home/{{ target_user }}/.profile"
    regexp: 'export PATH=\$PATH:\$HOME/\.pulumi/bin'
    line: 'export PATH=$PATH:$HOME/.pulumi/bin'
    create: yes
    owner: "{{ target_user }}"

# --- HELM SETUP ---
- name: Check if Helm is installed
  ansible.builtin.stat:
    path: "/usr/local/bin/helm"
  register: helm_check

- name: Download Helm installer script
  ansible.builtin.get_url:
    url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
    dest: /tmp/get_helm.sh
    mode: '0755'
  when: not helm_check.stat.exists

- name: Install Helm
  ansible.builtin.shell: /tmp/get_helm.sh
  args:
    creates: /usr/local/bin/helm
  when: not helm_check.stat.exists

# --- NUSHELL CONFIGURATION ---
- name: Ensure Nushell config directory exists
  ansible.builtin.file:
    path: "/home/{{ target_user }}/.config/nushell"
    state: directory
    owner: "{{ target_user }}"
    mode: '0755'

- name: Add Programming Envs to Nushell
  ansible.builtin.blockinfile:
    path: "/home/{{ target_user }}/.config/nushell/env.nu"
    marker: "# {mark} ANSIBLE MANAGED BLOCK (PROGRAMMING)"
    create: yes
    block: |
      $env.PATH = ($env.PATH | prepend '/usr/local/go/bin')
      $env.PATH = ($env.PATH | prepend ($env.HOME + '/go/bin'))
      $env.PATH = ($env.PATH | prepend ($env.HOME + '/.local/bin'))
      $env.PATH = ($env.PATH | prepend ($env.HOME + '/.cargo/bin'))
      $env.PATH = ($env.PATH | prepend ($env.HOME + '/.pulumi/bin'))
      $env.PATH = ($env.PATH | prepend ($env.HOME + '/.fnm'))
      # Initialize fnm for nushell
      fnm env --json | from json | load-env
    owner: "{{ target_user }}"